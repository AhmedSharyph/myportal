<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="auth.js"></script>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzdSJ_2mNS8XODvPlGJFPICHYUIA8qc26PodQ1f7Z0oWbOF430LMLo_3vIeMIK66UGzuw/exec";

document.addEventListener("DOMContentLoaded", async () => {
  const email = localStorage.getItem("userEmail");
  if (!email) return window.location.href = "index.html";

  const formData = new URLSearchParams({ action: "getUserProfile", email });
  const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
  const result = await res.json();

  if(result.success){
    document.getElementById("name").value = result.profile.name || "";
    document.getElementById("profilePicPreview").src = result.profile.profilePicUrl || "https://via.placeholder.com/100";
  }
});

// Update profile
async function updateProfile(e){
  e.preventDefault();
  const email = localStorage.getItem("userEmail");
  const name = document.getElementById("name").value;
  const profilePicUrl = document.getElementById("profilePicUrl").value;

  const formData = new URLSearchParams({
    action: "updateProfile",
    email,
    name,
    profilePicUrl
  });

  const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
  const result = await res.json();
  alert(result.message);
}

// Reset password
async function resetPassword(e){
  e.preventDefault();
  const email = localStorage.getItem("userEmail");
  const oldPassword = document.getElementById("oldPassword").value;
  const newPassword = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmNewPassword").value;

  if(newPassword !== confirmPassword){
    alert("New passwords do not match!");
    return;
  }

  const formData = new URLSearchParams({
    action: "resetPassword",
    email,
    oldPassword,
    newPassword
  });

  const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
  const result = await res.json();
  alert(result.message);
}
</script>
</head>
<body class="bg-gray-100">

<!-- Dynamic Header -->
<div class="bg-blue-600 text-white p-4 flex justify-between items-center">
  <div>User Profile</div>
  <button onclick="logout()" class="bg-red-500 p-2 rounded hover:bg-red-600">Logout</button>
</div>

<div class="p-8 max-w-lg mx-auto bg-white shadow rounded">
  <h2 class="text-2xl font-bold mb-4">Edit Profile</h2>
  
  <!-- Name & Profile Picture -->
  <form onsubmit="updateProfile(event)" class="mb-6">
    <label class="block mb-2">Full Name:</label>
    <input type="text" id="name" class="w-full p-2 border rounded mb-4" placeholder="Your name">
    
    <label class="block mb-2">Profile Picture URL:</label>
    <input type="text" id="profilePicUrl" class="w-full p-2 border rounded mb-2" placeholder="Image URL">
    <img id="profilePicPreview" src="https://via.placeholder.com/100" class="h-20 w-20 rounded-full mb-4">
    
    <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Update Profile</button>
  </form>

  <!-- Password Reset -->
  <form onsubmit="resetPassword(event)">
    <h3 class="text-xl font-semibold mb-2">Reset Password</h3>
    <input type="password" id="oldPassword" placeholder="Old Password" required class="w-full p-2 mb-2 border rounded">
    <input type="password" id="newPassword" placeholder="New Password" required class="w-full p-2 mb-2 border rounded">
    <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" required class="w-full p-2 mb-2 border rounded">
    <button type="submit" class="bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700">Reset Password</button>
  </form>
</div>

</body>
</html>
