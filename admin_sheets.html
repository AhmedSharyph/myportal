<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel - Multi Sheet</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="auth.js"></script>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzdSJ_2mNS8XODvPlGJFPICHYUIA8qc26PodQ1f7Z0oWbOF430LMLo_3vIeMIK66UGzuw/exec";

let currentSheet = "userDetails";
let sheetData = [];

// Check admin login
document.addEventListener("DOMContentLoaded", async () => {
  const email = localStorage.getItem("userEmail");
  const isAdmin = localStorage.getItem("isAdmin");
  if(!email || isAdmin !== "Yes") return alert("Access denied."), window.location.href="index.html";

  await loadSheets();
  await loadSheetData(currentSheet);
});

// ==================== SHEET MANAGEMENT ====================
async function loadSheets() {
  // For simplicity, we can predefine sheets or fetch from Web App if dynamic sheet list available
  const sheets = ["userDetails"]; // existing sheets, can extend
  const select = document.getElementById("sheetSelect");
  select.innerHTML = "";
  sheets.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    select.appendChild(opt);
  });
  select.value = currentSheet;
}

async function switchSheet() {
  currentSheet = document.getElementById("sheetSelect").value;
  await loadSheetData(currentSheet);
}

// ==================== SHEET DATA ====================
async function loadSheetData(sheetName) {
  const formData = new URLSearchParams({ action: "getSheetData", sheetName });
  const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
  const result = await res.json();
  if(result.success){
    sheetData = result.data.slice(1); // skip headers
    renderTable(result.data[0]); // headers
  }
}

function renderTable(headers){
  const tbody = document.getElementById("sheetTableBody");
  const thead = document.getElementById("sheetTableHead");

  // Render headers
  thead.innerHTML = "";
  headers.forEach(h => {
    const th = document.createElement("th");
    th.className = "border px-2 py-1";
    th.textContent = h;
    thead.appendChild(th);
  });
  const actionTh = document.createElement("th");
  actionTh.className = "border px-2 py-1";
  actionTh.textContent = "Actions";
  thead.appendChild(actionTh);

  // Render rows
  tbody.innerHTML = "";
  sheetData.forEach((row, i) => {
    const tr = document.createElement("tr");
    row.forEach(cell => {
      const td = document.createElement("td");
      td.className = "border px-2 py-1";
      td.textContent = cell;
      tr.appendChild(td);
    });
    const tdAction = document.createElement("td");
    tdAction.className = "border px-2 py-1 flex gap-2";
    tdAction.innerHTML = `<button onclick="deleteRow(${i})" class="bg-red-500 p-1 text-white rounded">Delete</button>`;
    tr.appendChild(tdAction);
    tbody.appendChild(tr);
  });
}

// Delete row
async function deleteRow(index){
  if(!confirm("Delete this row?")) return;
  const formData = new URLSearchParams({
    action: "deleteRow",
    sheetName: currentSheet,
    row: index + 2 // header + zero index
  });
  const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
  const result = await res.json();
  alert(result.message);
  await loadSheetData(currentSheet);
}

// Add Column
async function addColumn(e){
  e.preventDefault();
  const colName = document.getElementById("newColumn").value;
  const formData = new URLSearchParams({ action: "addColumn", sheetName: currentSheet, columnName: colName });
  const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
  const result = await res.json();
  alert(result.message);
  document.getElementById("addColumnForm").reset();
  await loadSheetData(currentSheet);
}

// Add Sheet
async function addSheet(e){
  e.preventDefault();
  const sheetName = document.getElementById("newSheet").value;
  const headers = document.getElementById("sheetHeaders").value.split(",").map(h => h.trim());
  const formData = new URLSearchParams({ action: "addSheet", sheetName, headers: JSON.stringify(headers) });
  const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
  const result = await res.json();
  alert(result.message);
  document.getElementById("addSheetForm").reset();
  await loadSheets();
}

// Logout
function logout() { localStorage.clear(); window.location.href="index.html"; }
</script>
</head>
<body class="bg-gray-100 p-6">

<!-- Header -->
<div class="bg-gray-800 text-white p-4 flex justify-between items-center mb-4">
  <div>Admin Panel - Multi Sheet</div>
  <button onclick="logout()" class="bg-red-600 p-2 rounded hover:bg-red-700">Logout</button>
</div>

<!-- Sheet Selector -->
<div class="mb-4">
  <label>Select Sheet: </label>
  <select id="sheetSelect" onchange="switchSheet()" class="border p-2 rounded"></select>
</div>

<!-- Add Column Form -->
<form id="addColumnForm" onsubmit="addColumn(event)" class="mb-4 bg-white p-4 rounded shadow">
  <h2 class="text-lg font-bold mb-2">Add Column to Current Sheet</h2>
  <input type="text" id="newColumn" placeholder="Column Name" required class="p-2 border rounded mb-2">
  <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Add Column</button>
</form>

<!-- Add New Sheet -->
<form id="addSheetForm" onsubmit="addSheet(event)" class="mb-4 bg-white p-4 rounded shadow">
  <h2 class="text-lg font-bold mb-2">Create New Sheet</h2>
  <input type="text" id="newSheet" placeholder="Sheet Name" required class="p-2 border rounded mb-2"><br>
  <input type="text" id="sheetHeaders" placeholder="Headers (comma separated)" required class="p-2 border rounded mb-2"><br>
  <button type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Create Sheet</button>
</form>

<!-- Sheet Data Table -->
<div class="bg-white p-4 rounded shadow overflow-x-auto">
  <table class="w-full border-collapse">
    <thead id="sheetTableHead"></thead>
    <tbody id="sheetTableBody"></tbody>
  </table>
</div>

</body>
</html>
